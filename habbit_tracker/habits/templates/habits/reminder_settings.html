{% extends 'habits/base.html' %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.enabled }}
                                <label class="form-check-label" for="{{ form.enabled.id_for_label }}">
                                    <strong>–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</strong>
                                </label>
                            </div>
                            {% if form.enabled.errors %}
                                <div class="text-danger small">{{ form.enabled.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                –ü–æ–ª—É—á–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–∏–≤—ã—á–∫–∞—Ö
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.reminder_time.id_for_label }}" class="form-label">
                                –í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                            </label>
                            {{ form.reminder_time }}
                            {% if form.reminder_time.errors %}
                                <div class="text-danger small">{{ form.reminder_time.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                –í –∫–∞–∫–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.email_notifications }}
                                <label class="form-check-label" for="{{ form.email_notifications.id_for_label }}">
                                    <strong>Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong>
                                </label>
                            </div>
                            {% if form.email_notifications.errors %}
                                <div class="text-danger small">{{ form.email_notifications.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                –ü–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ email
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.telegram_notifications }}
                                <label class="form-check-label" for="{{ form.telegram_notifications.id_for_label }}">
                                    <strong>Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</strong>
                                </label>
                            </div>
                            {% if form.telegram_notifications.errors %}
                                <div class="text-danger small">{{ form.telegram_notifications.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                –ü–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ Telegram (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
                            </div>
                        </div>

                        {% if form.telegram_notifications.value %}
                        <div class="mb-3" id="telegram-fields">
                            <label for="{{ form.telegram_chat_id.id_for_label }}" class="form-label">
                                Telegram Chat ID
                            </label>
                            {{ form.telegram_chat_id }}
                            {% if form.telegram_chat_id.errors %}
                                <div class="text-danger small">{{ form.telegram_chat_id.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                –í–∞—à ID —á–∞—Ç–∞ –≤ Telegram
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'index' %}" class="btn btn-secondary me-md-2">–û—Ç–º–µ–Ω–∞</a>
                            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        </div>
                    </form>

                    <hr class="my-4">

                    <div class="alert alert-info">
                        <h5 class="alert-heading">‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h5>
                        <ul class="mb-0">
                            <li>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</li>
                            <li>–í—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≤—ã—á–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è</li>
                            <li>–î–ª—è —Ä–∞–±–æ—Ç—ã email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω SMTP —Å–µ—Ä–≤–µ—Ä</li>
                            <li>Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏:</h6>
                        <div class="display-6 text-primary">{{ active_habits_count }}</div>
                        <small class="text-muted">–ø—Ä–∏–≤—ã—á–µ–∫ —Ç—Ä–µ–±—É—é—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</small>
                    </div>

                    <div class="mb-3">
                        <h6>–°–ª–µ–¥—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:</h6>
                        {% if next_reminder_time %}
                            <div class="text-success">{{ next_reminder_time|time:"H:i" }}</div>
                            <small class="text-muted">—Å–µ–≥–æ–¥–Ω—è</small>
                        {% else %}
                            <div class="text-muted">–ù–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                        {% endif %}
                    </div>

                    <div>
                        <h6>–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞:</h6>
                        {% if last_sent %}
                            <div>{{ last_sent|date:"d.m.Y H:i" }}</div>
                            <small class="text-muted">—É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</small>
                        {% else %}
                            <div class="text-muted">–ï—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">‚öôÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:</p>
                    <form method="post" action="{% url 'test_reminder' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-primary w-100">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                        </button>
                    </form>
                    <small class="text-muted d-block mt-2">
                        –í—ã –ø–æ–ª—É—á–∏—Ç–µ email —Å–æ —Å–ø–∏—Å–∫–æ–º –≤–∞—à–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ Telegram Chat ID –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
document.getElementById('{{ form.telegram_notifications.id_for_label }}').addEventListener('change', function() {
    const telegramFields = document.getElementById('telegram-fields');
    if (telegramFields) {
        telegramFields.style.display = this.checked ? 'block' : 'none';
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã Bootstrap –∫ –ø–æ–ª—è–º —Ñ–æ—Ä–º—ã
document.addEventListener('DOMContentLoaded', function() {
    const timeField = document.getElementById('{{ form.reminder_time.id_for_label }}');
    if (timeField) {
        timeField.className = 'form-control';
        timeField.type = 'time';
    }

    const telegramField = document.getElementById('{{ form.telegram_chat_id.id_for_label }}');
    if (telegramField) {
        telegramField.className = 'form-control';
    }
});
</script>
{% endblock %}