{% extends 'habits/base.html' %}

{% block title %}–î–∞—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">üìà –î–∞—à–±–æ—Ä–¥ –ø—Ä–∏–≤—ã—á–µ–∫</h1>
            <p class="lead">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –≤–∞—à–∏–º –ø—Ä–∏–≤—ã—á–∫–∞–º</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤—Å–µ–º –ø—Ä–∏–≤—ã—á–∫–∞–º</h5>
                </div>
                <div class="card-body">
                    <canvas id="habitsChart" height="120"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üéØ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                </div>
                <div class="card-body text-center">
                    <div class="display-4 text-primary mb-2">{{ total_habits }}</div>
                    <p class="text-muted">–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫</p>

                    <div class="display-4 text-success mb-2">{{ average_completion }}%</div>
                    <p class="text-muted">—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>

                    <a href="{% url 'index' %}" class="btn btn-primary w-100 mt-3">
                        üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∞–º–∏
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–ü—Ä–∏–≤—ã—á–∫–∞</th>
                                    <th>–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</th>
                                    <th>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (30 –¥–Ω–µ–π)</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in stats %}
                                <tr>
                                    <td>
                                        <strong>{{ stat.habit.name }}</strong><br>
                                        <small class="text-muted">{{ stat.habit.description|truncatechars:50 }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary fs-6">
                                            {{ stat.current_streak }} –¥–Ω–µ–π
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                                <div class="progress-bar bg-{{ stat.status }}"
                                                     style="width: {{ stat.completion_rate }}%">
                                                    {{ stat.completion_rate }}%
                                                </div>
                                            </div>
                                            <span class="text-nowrap">
                                                {{ stat.habit.logs.filter(completed=True).count }} –≤—Å–µ–≥–æ
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if stat.completion_rate >= 80 %}
                                            <span class="badge bg-success">–û—Ç–ª–∏—á–Ω–æ</span>
                                        {% elif stat.completion_rate >= 60 %}
                                            <span class="badge bg-info">–•–æ—Ä–æ—à–æ</span>
                                        {% elif stat.completion_rate >= 40 %}
                                            <span class="badge bg-warning">–°—Ä–µ–¥–Ω–µ</span>
                                        {% else %}
                                            <span class="badge bg-danger">–ù—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'statistics' stat.habit.id %}"
                                               class="btn btn-outline-primary">
                                                üìä
                                            </a>
                                            <a href="{% url 'calendar' stat.habit.id %}"
                                               class="btn btn-outline-secondary">
                                                üìÖ
                                            </a>
                                            <a href="{% url 'log_habit' stat.habit.id %}"
                                               class="btn btn-outline-success">
                                                ‚úì
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="text-muted">
                                            –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫.
                                            <a href="{% url 'create_habit' %}">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
const habitsCtx = document.getElementById('habitsChart').getContext('2d');
const habitsChart = new Chart(habitsCtx, {
    type: 'bar',
    data: {
        labels: {{ habit_names|safe }},
        datasets: [{
            label: '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞ 30 –¥–Ω–µ–π',
            data: {{ completion_rates|safe }},
            backgroundColor: function(context) {
                const value = context.dataset.data[context.dataIndex];
                if (value >= 80) return '#28a745';
                if (value >= 60) return '#17a2b8';
                if (value >= 40) return '#ffc107';
                return '#dc3545';
            },
            borderColor: '#fff',
            borderWidth: 2,
            borderRadius: 5,
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.parsed.y}% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (%)'
                }
            }
        }
    }
});
</script>
{% endblock %}